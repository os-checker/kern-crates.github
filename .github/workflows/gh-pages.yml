# @format

name: GitHub Deploy Workflow

permissions: write-all

env:
  TOKEN: ${{ secrets.GITHUB_TOKEN }}
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

on:
  schedule:
    - cron: '0 */1 * * *'
  push:
    branches:
      - os-checker
  workflow_dispatch:
jobs:
  build:
    name: Deploying
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: install nodejs
        uses: actions/setup-node@v4
        with:
          node-version: latest
      - name: install spider pkg and run
        run: |
          cd spider && npm install
          npm run start # the output: web/data.json
      - name: commit and push json
        run: |
          # author zjp-CN, and commiter bot
          git config --global user.name "zjp-CN"
          git config --global user.email "jiping_zhou@foxmail.com"
          git config --global committer.name "zjp-CN[bot]"
          git config --global committer.email "zjp-CN[bot]@users.noreply.github.com"

          git switch os-checker
          cp web/data.json ./

          # os-checker 暂时只需要 "user/repo"
          jq 'map(.repo)' data.json > array-of-repos.json

          export stuff=array-of-repos.json

          echo "正在提交 ${stuff} 到 os-checker 分支"
          git status
          git add ${stuff}
          git commit -m "[bot] update ${stuff}"
          git push
          echo 🎉
